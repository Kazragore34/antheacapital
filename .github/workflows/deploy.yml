name: Build and Deploy

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json
    
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Build Frontend
      run: |
        cd frontend
        npm run build
    
    - name: Install Backend Dependencies
      run: |
        cd backend
        echo "ğŸ“¦ Instalando dependencias del backend..."
        npm ci || {
          echo "âš ï¸ npm ci fallÃ³, intentando npm install..."
          npm install
        }
        # Verificar que xml2js estÃ© instalado
        echo "ğŸ” Verificando xml2js..."
        if ! npm list xml2js 2>/dev/null; then
          echo "âš ï¸ xml2js no encontrado, instalando..."
          npm install xml2js
        else
          echo "âœ… xml2js ya estÃ¡ instalado"
        fi
    
    - name: Build Backend
      run: |
        cd backend
        echo "ğŸ”¨ Compilando backend..."
        npm run build || {
          echo "âŒ Build fallÃ³, intentando con mÃ¡s detalles..."
          npm run build 2>&1 | head -50
          exit 1
        }
        echo "âœ… Build completado"
        # Verificar que dist existe
        if [ ! -d "dist" ]; then
          echo "âŒ ERROR: dist/ no se creÃ³ despuÃ©s del build"
          exit 1
        fi
        echo "âœ… dist/ creado correctamente"
        ls -la dist/ | head -10
    
    - name: Prepare Deployment
      run: |
        mkdir -p deploy
        # PRIORIDAD: Copiar archivos de la raÃ­z primero (generados por deploy-frontend.bat)
        # Estos son los archivos que realmente se deben subir
        if [ -f index.html ]; then
          cp index.html deploy/
          echo "âœ… Copiado index.html de la raÃ­z"
        else
          # Fallback: usar el de frontend/dist
          cp frontend/dist/index.html deploy/
          echo "âš ï¸ Usando index.html de frontend/dist (fallback)"
        fi
        
        if [ -d assets ]; then
          cp -r assets deploy/
          echo "âœ… Copiado assets/ de la raÃ­z"
        else
          # Fallback: usar el de frontend/dist
          cp -r frontend/dist/assets deploy/ 2>/dev/null || true
          echo "âš ï¸ Usando assets/ de frontend/dist (fallback)"
        fi
        
        # Copiar .htaccess (prioridad: raÃ­z > frontend/dist)
        if [ -f .htaccess ]; then
          cp .htaccess deploy/
          echo "âœ… Copiado .htaccess de la raÃ­z"
        elif [ -f frontend/dist/.htaccess ]; then
          cp frontend/dist/.htaccess deploy/
          echo "âš ï¸ Usando .htaccess de frontend/dist (fallback)"
        fi
        
        # Copiar listacontactos.html si existe
        if [ -f listacontactos.html ]; then
          cp listacontactos.html deploy/
          echo "âœ… Copiado listacontactos.html"
        fi
        
        # Copiar archivos XML e imÃ¡genes si existen
        if [ -d "archivos en bruto" ]; then
          mkdir -p "deploy/archivos en bruto"
          cp -r "archivos en bruto"/* "deploy/archivos en bruto/" 2>/dev/null || true
          echo "âœ… Copiado archivos en bruto/ (incluyendo imÃ¡genes si existen)"
        fi
        
        # Copiar carpetas PHP de Inmovilla (ficha/ y cliente/)
        if [ -d "ficha" ]; then
          cp -r ficha deploy/
          echo "âœ… Copiado carpeta ficha/ (PHP de Inmovilla)"
        fi
        
        if [ -d "cliente" ]; then
          cp -r cliente deploy/
          echo "âœ… Copiado carpeta cliente/ (PHP de Inmovilla)"
        fi
        
        # Backend - COPIAR TODO LO NECESARIO
        echo "ğŸ“¦ Preparando backend para deploy..."
        mkdir -p deploy/backend
        
        # Verificar que dist existe despuÃ©s del build
        if [ ! -d "backend/dist" ]; then
          echo "âŒ ERROR: backend/dist no existe despuÃ©s del build!"
          echo "ğŸ” Intentando construir de nuevo..."
          cd backend
          npm run build || {
            echo "âŒ Build fallÃ³, continuando de todas formas..."
            cd ..
            exit 0  # Continuar aunque falle para ver otros errores
          }
          cd ..
          if [ ! -d "backend/dist" ]; then
            echo "âŒ ERROR: backend/dist aÃºn no existe despuÃ©s del rebuild"
            exit 1
          fi
        fi
        
        # Copiar cÃ³digo compilado
        echo "ğŸ“‚ Copiando backend/dist..."
        cp -r backend/dist deploy/backend/
        echo "âœ… Backend dist copiado"
        
        # Copiar archivos de configuraciÃ³n
        echo "ğŸ“„ Copiando archivos de configuraciÃ³n..."
        cp backend/package.json deploy/backend/
        cp backend/package-lock.json deploy/backend/ 2>/dev/null || true
        cp backend/.env.example deploy/backend/.env.example 2>/dev/null || true
        cp backend/tsconfig.json deploy/backend/ 2>/dev/null || true
        cp backend/nest-cli.json deploy/backend/ 2>/dev/null || true
        
        # CRÃTICO: Copiar node_modules del backend para que xml2js estÃ© disponible
        echo "ğŸ“¦ Copiando node_modules (esto puede tardar)..."
        if [ -d "backend/node_modules" ]; then
          # Verificar que xml2js existe antes de copiar
          if [ -d "backend/node_modules/xml2js" ]; then
            echo "âœ… xml2js encontrado en node_modules"
          else
            echo "âš ï¸ WARNING: xml2js NO encontrado en node_modules, instalando..."
            cd backend
            npm install xml2js
            cd ..
          fi
          # Copiar node_modules (usar tar para mejor rendimiento con muchos archivos)
          echo "ğŸ“¦ Copiando node_modules (puede tardar varios minutos)..."
          cp -r backend/node_modules deploy/backend/ || {
            echo "âš ï¸ Error copiando node_modules completo, intentando copiar solo xml2js..."
            mkdir -p deploy/backend/node_modules
            cp -r backend/node_modules/xml2js deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/@nestjs deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/@types deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/class-validator deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/class-transformer deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/reflect-metadata deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/rxjs deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/mongoose deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/bcrypt deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/passport deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/passport-jwt deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/nodemailer deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/cloudinary deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/multer deploy/backend/node_modules/ 2>/dev/null || true
            # Copiar archivos package.json de node_modules para resolver dependencias
            find backend/node_modules -name "package.json" -type f | head -100 | while read pkg; do
              rel_path=$(echo $pkg | sed 's|backend/node_modules/||')
              mkdir -p "deploy/backend/node_modules/$(dirname $rel_path)"
              cp "$pkg" "deploy/backend/node_modules/$rel_path" 2>/dev/null || true
            done
          }
          echo "âœ… Backend node_modules copiado"
        else
          echo "âŒ ERROR: backend/node_modules no encontrado!"
          echo "âš ï¸ Intentando instalar dependencias..."
          cd backend
          npm install
          cd ..
          if [ -d "backend/node_modules" ]; then
            cp -r backend/node_modules deploy/backend/
            echo "âœ… node_modules instalado y copiado"
          else
            echo "âš ï¸ WARNING: No se pudo instalar node_modules completo"
            echo "âš ï¸ Continuando - las dependencias se pueden instalar en el servidor"
            # NO salir con error, solo advertir
          fi
        fi
        
        # Verificar que xml2js estÃ¡ en el deploy
        if [ -d "deploy/backend/node_modules/xml2js" ]; then
          echo "âœ… xml2js verificado en deploy/backend/node_modules/"
        else
          echo "âš ï¸ WARNING: xml2js NO estÃ¡ en deploy/backend/node_modules/"
          echo "âš ï¸ Continuando de todas formas - se puede instalar en el servidor"
          # NO salir con error, solo advertir
        fi
        
        # Copiar archivos de configuraciÃ³n para Hostinger
        echo "âš™ï¸ Copiando scripts de inicio y configuraciÃ³n..."
        if [ -f backend/start.sh ]; then
          cp backend/start.sh deploy/backend/
          chmod +x deploy/backend/start.sh
          echo "âœ… start.sh copiado y hecho ejecutable"
        else
          echo "âš ï¸ start.sh no encontrado"
        fi
        if [ -f backend/start.bat ]; then
          cp backend/start.bat deploy/backend/
          echo "âœ… start.bat copiado"
        fi
        if [ -f backend/.htaccess ]; then
          cp backend/.htaccess deploy/backend/
          echo "âœ… backend/.htaccess copiado"
        fi
        if [ -f backend/ecosystem.config.js ]; then
          cp backend/ecosystem.config.js deploy/backend/
          echo "âœ… ecosystem.config.js copiado"
        fi
        
        # Verificar estructura final
        echo "ğŸ” Verificando estructura del backend..."
        echo "  - dist/main.js: $([ -f deploy/backend/dist/main.js ] && echo 'âœ…' || echo 'âŒ')"
        echo "  - package.json: $([ -f deploy/backend/package.json ] && echo 'âœ…' || echo 'âŒ')"
        echo "  - node_modules/xml2js: $([ -d deploy/backend/node_modules/xml2js ] && echo 'âœ…' || echo 'âŒ')"
        echo "  - start.sh: $([ -f deploy/backend/start.sh ] && echo 'âœ…' || echo 'âŒ')"
        
        echo "âœ… Backend completamente preparado para deploy"
    
    - name: Verificar estructura antes de deploy
      run: |
        echo "ğŸ” Verificando estructura de deploy antes de subir..."
        echo "ğŸ“ Contenido de deploy/:"
        ls -la deploy/ || echo "deploy/ no existe"
        echo ""
        echo "ğŸ“ Contenido de deploy/backend/:"
        ls -la deploy/backend/ || echo "deploy/backend/ no existe"
        echo ""
        echo "ğŸ“ Verificando dist/:"
        if [ -d "deploy/backend/dist" ]; then
          echo "âœ… dist/ existe"
          ls -la deploy/backend/dist/ | head -10
          echo "ğŸ“Š TamaÃ±o: $(du -sh deploy/backend/dist | cut -f1)"
        else
          echo "âŒ dist/ NO existe"
        fi
        echo ""
        echo "ğŸ“ Verificando node_modules/:"
        if [ -d "deploy/backend/node_modules" ]; then
          echo "âœ… node_modules/ existe"
          ls -la deploy/backend/node_modules/ | head -10
          echo "ğŸ“Š TamaÃ±o: $(du -sh deploy/backend/node_modules | cut -f1)"
          if [ -d "deploy/backend/node_modules/xml2js" ]; then
            echo "âœ… xml2js encontrado en node_modules"
          else
            echo "âŒ xml2js NO encontrado en node_modules"
          fi
        else
          echo "âŒ node_modules/ NO existe"
        fi
        echo ""
        echo "âœ… VerificaciÃ³n completada"
    
    - name: Deploy to Hostinger (SFTP)
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 65002
        source: "./deploy/*"
        target: "/public_html/"
        strip_components: 1
        rm: false

