name: Build and Deploy

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json
    
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Build Frontend
      run: |
        cd frontend
        # Limpiar build anterior para evitar c√≥digo antiguo
        rm -rf dist node_modules/.vite
        echo "üßπ Build anterior limpiado"
        # Rebuild sin cach√©
        npm run build
        echo "‚úÖ Frontend build completado"
        # Verificar que no hay referencias a XML en el c√≥digo compilado
        if grep -r "XMLPropertiesService\|xml-proxy\|xml-properties" dist/ 2>/dev/null; then
          echo "‚ö†Ô∏è WARNING: Se encontraron referencias a XML en el build!"
          exit 1
        else
          echo "‚úÖ Verificado: No hay referencias a XML en el build"
        fi
    
    - name: Install Backend Dependencies
      run: |
        cd backend
        echo "üì¶ Instalando dependencias del backend..."
        npm ci || {
          echo "‚ö†Ô∏è npm ci fall√≥, intentando npm install..."
          npm install
        }
        # Verificar que xml2js est√© instalado
        echo "üîç Verificando xml2js..."
        if ! npm list xml2js 2>/dev/null; then
          echo "‚ö†Ô∏è xml2js no encontrado, instalando..."
          npm install xml2js
        else
          echo "‚úÖ xml2js ya est√° instalado"
        fi
    
    - name: Build Backend
      run: |
        cd backend
        echo "üî® Compilando backend..."
        npm run build || {
          echo "‚ùå Build fall√≥, intentando con m√°s detalles..."
          npm run build 2>&1 | head -50
          exit 1
        }
        echo "‚úÖ Build completado"
        # Verificar que dist existe
        if [ ! -d "dist" ]; then
          echo "‚ùå ERROR: dist/ no se cre√≥ despu√©s del build"
          exit 1
        fi
        echo "‚úÖ dist/ creado correctamente"
        ls -la dist/ | head -10
    
    - name: Prepare Deployment
      run: |
        mkdir -p deploy
        # CR√çTICO: Usar SOLO el c√≥digo compilado reci√©n construido de frontend/dist
        # NO usar archivos de la ra√≠z que pueden estar desactualizados
        echo "üì¶ Copiando c√≥digo compilado desde frontend/dist..."
        
        if [ ! -d "frontend/dist" ]; then
          echo "‚ùå ERROR: frontend/dist no existe despu√©s del build!"
          exit 1
        fi
        
        # Copiar index.html desde frontend/dist (SIEMPRE el m√°s reciente)
        cp frontend/dist/index.html deploy/
        echo "‚úÖ Copiado index.html desde frontend/dist"
        
        # Copiar assets desde frontend/dist (SIEMPRE el m√°s reciente)
        if [ -d "frontend/dist/assets" ]; then
          cp -r frontend/dist/assets deploy/
          echo "‚úÖ Copiado assets/ desde frontend/dist"
        else
          echo "‚ùå ERROR: frontend/dist/assets no existe!"
          exit 1
        fi
        
        # Verificar que el c√≥digo compilado NO tiene referencias a XML
        if grep -r "XMLPropertiesService\|xml-proxy\|xml-properties" frontend/dist/ 2>/dev/null; then
          echo "‚ùå ERROR: El c√≥digo compilado todav√≠a tiene referencias a XML!"
          echo "üîç Buscando referencias..."
          grep -r "XMLPropertiesService\|xml-proxy\|xml-properties" frontend/dist/ || true
          exit 1
        else
          echo "‚úÖ Verificado: El c√≥digo compilado NO tiene referencias a XML"
        fi
        
        # Copiar .htaccess (prioridad: ra√≠z > frontend/dist)
        if [ -f .htaccess ]; then
          cp .htaccess deploy/
          echo "‚úÖ Copiado .htaccess de la ra√≠z"
        elif [ -f frontend/dist/.htaccess ]; then
          cp frontend/dist/.htaccess deploy/
          echo "‚ö†Ô∏è Usando .htaccess de frontend/dist (fallback)"
        fi
        
        # Copiar listacontactos.html si existe
        if [ -f listacontactos.html ]; then
          cp listacontactos.html deploy/
          echo "‚úÖ Copiado listacontactos.html"
        fi
        
        # Copiar archivos XML e im√°genes si existen
        if [ -d "archivos en bruto" ]; then
          mkdir -p "deploy/archivos en bruto"
          cp -r "archivos en bruto"/* "deploy/archivos en bruto/" 2>/dev/null || true
          echo "‚úÖ Copiado archivos en bruto/ (incluyendo im√°genes si existen)"
        fi
        
        # Copiar carpetas PHP de Inmovilla (ficha/ y cliente/)
        if [ -d "ficha" ]; then
          cp -r ficha deploy/
          echo "‚úÖ Copiado carpeta ficha/ (PHP de Inmovilla)"
        fi
        
        if [ -d "cliente" ]; then
          cp -r cliente deploy/
          echo "‚úÖ Copiado carpeta cliente/ (PHP de Inmovilla)"
        fi
        
        # Copiar xml-proxy.php si existe
        if [ -f "xml-proxy.php" ]; then
          cp xml-proxy.php deploy/
          echo "‚úÖ Copiado xml-proxy.php (proxy CORS para XML)"
        fi
        
        # Copiar api-inmovilla-proxy.php si existe (proxy para API de Inmovilla antigua)
        if [ -f "api-inmovilla-proxy.php" ]; then
          cp api-inmovilla-proxy.php deploy/
          echo "‚úÖ Copiado api-inmovilla-proxy.php (proxy para API de Inmovilla antigua)"
        fi
        
        # Copiar api-inmovilla-rest-proxy.php si existe (proxy para API REST de Inmovilla)
        if [ -f "api-inmovilla-rest-proxy.php" ]; then
          cp api-inmovilla-rest-proxy.php deploy/
          echo "‚úÖ Copiado api-inmovilla-rest-proxy.php (proxy para API REST de Inmovilla)"
        fi
        
        # Backend - COPIAR TODO LO NECESARIO
        echo "üì¶ Preparando backend para deploy..."
        mkdir -p deploy/backend
        
        # Verificar que dist existe despu√©s del build
        if [ ! -d "backend/dist" ]; then
          echo "‚ùå ERROR: backend/dist no existe despu√©s del build!"
          echo "üîç Intentando construir de nuevo..."
          cd backend
          npm run build || {
            echo "‚ùå Build fall√≥, continuando de todas formas..."
            cd ..
            exit 0  # Continuar aunque falle para ver otros errores
          }
          cd ..
          if [ ! -d "backend/dist" ]; then
            echo "‚ùå ERROR: backend/dist a√∫n no existe despu√©s del rebuild"
            exit 1
          fi
        fi
        
        # Copiar c√≥digo compilado
        echo "üìÇ Copiando backend/dist..."
        cp -r backend/dist deploy/backend/
        echo "‚úÖ Backend dist copiado"
        
        # Copiar archivos de configuraci√≥n
        echo "üìÑ Copiando archivos de configuraci√≥n..."
        cp backend/package.json deploy/backend/
        cp backend/package-lock.json deploy/backend/ 2>/dev/null || true
        cp backend/.env.example deploy/backend/.env.example 2>/dev/null || true
        cp backend/tsconfig.json deploy/backend/ 2>/dev/null || true
        cp backend/nest-cli.json deploy/backend/ 2>/dev/null || true
        
        # CR√çTICO: Copiar node_modules del backend para que xml2js est√© disponible
        echo "üì¶ Copiando node_modules (esto puede tardar)..."
        if [ -d "backend/node_modules" ]; then
          # Verificar que xml2js existe antes de copiar
          if [ -d "backend/node_modules/xml2js" ]; then
            echo "‚úÖ xml2js encontrado en node_modules"
          else
            echo "‚ö†Ô∏è WARNING: xml2js NO encontrado en node_modules, instalando..."
            cd backend
            npm install xml2js
            cd ..
          fi
          # Copiar node_modules (usar tar para mejor rendimiento con muchos archivos)
          echo "üì¶ Copiando node_modules (puede tardar varios minutos)..."
          cp -r backend/node_modules deploy/backend/ || {
            echo "‚ö†Ô∏è Error copiando node_modules completo, intentando copiar solo xml2js..."
            mkdir -p deploy/backend/node_modules
            cp -r backend/node_modules/xml2js deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/@nestjs deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/@types deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/class-validator deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/class-transformer deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/reflect-metadata deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/rxjs deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/mongoose deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/bcrypt deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/passport deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/passport-jwt deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/nodemailer deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/cloudinary deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/multer deploy/backend/node_modules/ 2>/dev/null || true
            # Copiar archivos package.json de node_modules para resolver dependencias
            find backend/node_modules -name "package.json" -type f | head -100 | while read pkg; do
              rel_path=$(echo $pkg | sed 's|backend/node_modules/||')
              mkdir -p "deploy/backend/node_modules/$(dirname $rel_path)"
              cp "$pkg" "deploy/backend/node_modules/$rel_path" 2>/dev/null || true
            done
          }
          echo "‚úÖ Backend node_modules copiado"
        else
          echo "‚ùå ERROR: backend/node_modules no encontrado!"
          echo "‚ö†Ô∏è Intentando instalar dependencias..."
          cd backend
          npm install
          cd ..
          if [ -d "backend/node_modules" ]; then
            cp -r backend/node_modules deploy/backend/
            echo "‚úÖ node_modules instalado y copiado"
          else
            echo "‚ö†Ô∏è WARNING: No se pudo instalar node_modules completo"
            echo "‚ö†Ô∏è Continuando - las dependencias se pueden instalar en el servidor"
            # NO salir con error, solo advertir
          fi
        fi
        
        # Verificar que xml2js est√° en el deploy
        if [ -d "deploy/backend/node_modules/xml2js" ]; then
          echo "‚úÖ xml2js verificado en deploy/backend/node_modules/"
        else
          echo "‚ö†Ô∏è WARNING: xml2js NO est√° en deploy/backend/node_modules/"
          echo "‚ö†Ô∏è Continuando de todas formas - se puede instalar en el servidor"
          # NO salir con error, solo advertir
        fi
        
        # Copiar archivos de configuraci√≥n para Hostinger
        echo "‚öôÔ∏è Copiando scripts de inicio y configuraci√≥n..."
        if [ -f backend/start.sh ]; then
          cp backend/start.sh deploy/backend/
          chmod +x deploy/backend/start.sh
          echo "‚úÖ start.sh copiado y hecho ejecutable"
        else
          echo "‚ö†Ô∏è start.sh no encontrado"
        fi
        if [ -f backend/start.bat ]; then
          cp backend/start.bat deploy/backend/
          echo "‚úÖ start.bat copiado"
        fi
        if [ -f backend/.htaccess ]; then
          cp backend/.htaccess deploy/backend/
          echo "‚úÖ backend/.htaccess copiado"
        fi
        if [ -f backend/ecosystem.config.js ]; then
          cp backend/ecosystem.config.js deploy/backend/
          echo "‚úÖ ecosystem.config.js copiado"
        fi
        
        # Verificar estructura final
        echo "üîç Verificando estructura del backend..."
        echo "  - dist/main.js: $([ -f deploy/backend/dist/main.js ] && echo '‚úÖ' || echo '‚ùå')"
        echo "  - package.json: $([ -f deploy/backend/package.json ] && echo '‚úÖ' || echo '‚ùå')"
        echo "  - node_modules/xml2js: $([ -d deploy/backend/node_modules/xml2js ] && echo '‚úÖ' || echo '‚ùå')"
        echo "  - start.sh: $([ -f deploy/backend/start.sh ] && echo '‚úÖ' || echo '‚ùå')"
        
        echo "‚úÖ Backend completamente preparado para deploy"
    
    - name: Verificar estructura antes de deploy
      run: |
        echo "üîç Verificando estructura de deploy antes de subir..."
        echo "üìÅ Contenido de deploy/:"
        ls -la deploy/ || echo "deploy/ no existe"
        echo ""
        echo "üìÅ Contenido de deploy/backend/:"
        ls -la deploy/backend/ || echo "deploy/backend/ no existe"
        echo ""
        echo "üìÅ Verificando dist/:"
        if [ -d "deploy/backend/dist" ]; then
          echo "‚úÖ dist/ existe"
          ls -la deploy/backend/dist/ | head -10
          echo "üìä Tama√±o: $(du -sh deploy/backend/dist | cut -f1)"
        else
          echo "‚ùå dist/ NO existe"
        fi
        echo ""
        echo "üìÅ Verificando node_modules/:"
        if [ -d "deploy/backend/node_modules" ]; then
          echo "‚úÖ node_modules/ existe"
          ls -la deploy/backend/node_modules/ | head -10
          echo "üìä Tama√±o: $(du -sh deploy/backend/node_modules | cut -f1)"
          if [ -d "deploy/backend/node_modules/xml2js" ]; then
            echo "‚úÖ xml2js encontrado en node_modules"
          else
            echo "‚ùå xml2js NO encontrado en node_modules"
          fi
        else
          echo "‚ùå node_modules/ NO existe"
        fi
        echo ""
        echo "‚úÖ Verificaci√≥n completada"
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.FTP_PASSWORD }}" | sshpass -p "${{ secrets.FTP_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 65002 ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} "echo 'SSH connection test'"
    
    - name: Deploy to Hostinger (SFTP via rsync)
      run: |
        sudo apt-get update && sudo apt-get install -y sshpass rsync
        sshpass -p "${{ secrets.FTP_PASSWORD }}" rsync -avz --delete \
          -e "ssh -p 65002 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
          ./deploy/ \
          ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }}:/home/u571508109/domains/antheacapital.com/public_html/

