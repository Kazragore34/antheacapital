name: Build and Deploy

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json
    
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Build Frontend
      run: |
        cd frontend
        npm run build
    
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm ci
        # Verificar que xml2js est√© instalado
        npm list xml2js || npm install xml2js
    
    - name: Build Backend
      run: |
        cd backend
        npm run build
    
    - name: Prepare Deployment
      run: |
        mkdir -p deploy
        # PRIORIDAD: Copiar archivos de la ra√≠z primero (generados por deploy-frontend.bat)
        # Estos son los archivos que realmente se deben subir
        if [ -f index.html ]; then
          cp index.html deploy/
          echo "‚úÖ Copiado index.html de la ra√≠z"
        else
          # Fallback: usar el de frontend/dist
          cp frontend/dist/index.html deploy/
          echo "‚ö†Ô∏è Usando index.html de frontend/dist (fallback)"
        fi
        
        if [ -d assets ]; then
          cp -r assets deploy/
          echo "‚úÖ Copiado assets/ de la ra√≠z"
        else
          # Fallback: usar el de frontend/dist
          cp -r frontend/dist/assets deploy/ 2>/dev/null || true
          echo "‚ö†Ô∏è Usando assets/ de frontend/dist (fallback)"
        fi
        
        # Copiar .htaccess (prioridad: ra√≠z > frontend/dist)
        if [ -f .htaccess ]; then
          cp .htaccess deploy/
          echo "‚úÖ Copiado .htaccess de la ra√≠z"
        elif [ -f frontend/dist/.htaccess ]; then
          cp frontend/dist/.htaccess deploy/
          echo "‚ö†Ô∏è Usando .htaccess de frontend/dist (fallback)"
        fi
        
        # Copiar listacontactos.html si existe
        if [ -f listacontactos.html ]; then
          cp listacontactos.html deploy/
          echo "‚úÖ Copiado listacontactos.html"
        fi
        
        # Copiar archivos XML e im√°genes si existen
        if [ -d "archivos en bruto" ]; then
          mkdir -p "deploy/archivos en bruto"
          cp -r "archivos en bruto"/* "deploy/archivos en bruto/" 2>/dev/null || true
          echo "‚úÖ Copiado archivos en bruto/ (incluyendo im√°genes si existen)"
        fi
        
        # Copiar carpetas PHP de Inmovilla (ficha/ y cliente/)
        if [ -d "ficha" ]; then
          cp -r ficha deploy/
          echo "‚úÖ Copiado carpeta ficha/ (PHP de Inmovilla)"
        fi
        
        if [ -d "cliente" ]; then
          cp -r cliente deploy/
          echo "‚úÖ Copiado carpeta cliente/ (PHP de Inmovilla)"
        fi
        
        # Backend - COPIAR TODO LO NECESARIO
        echo "üì¶ Preparando backend para deploy..."
        mkdir -p deploy/backend
        
        # Verificar que dist existe despu√©s del build
        if [ ! -d "backend/dist" ]; then
          echo "‚ùå ERROR: backend/dist no existe despu√©s del build!"
          exit 1
        fi
        
        # Copiar c√≥digo compilado
        echo "üìÇ Copiando backend/dist..."
        cp -r backend/dist deploy/backend/
        echo "‚úÖ Backend dist copiado"
        
        # Copiar archivos de configuraci√≥n
        echo "üìÑ Copiando archivos de configuraci√≥n..."
        cp backend/package.json deploy/backend/
        cp backend/package-lock.json deploy/backend/ 2>/dev/null || true
        cp backend/.env.example deploy/backend/.env.example 2>/dev/null || true
        cp backend/tsconfig.json deploy/backend/ 2>/dev/null || true
        cp backend/nest-cli.json deploy/backend/ 2>/dev/null || true
        
        # CR√çTICO: Copiar node_modules del backend para que xml2js est√© disponible
        echo "üì¶ Copiando node_modules (esto puede tardar)..."
        if [ -d "backend/node_modules" ]; then
          # Verificar que xml2js existe antes de copiar
          if [ -d "backend/node_modules/xml2js" ]; then
            echo "‚úÖ xml2js encontrado en node_modules"
          else
            echo "‚ö†Ô∏è WARNING: xml2js NO encontrado en node_modules, instalando..."
            cd backend
            npm install xml2js
            cd ..
          fi
          # Copiar node_modules (usar tar para mejor rendimiento con muchos archivos)
          echo "üì¶ Copiando node_modules (puede tardar varios minutos)..."
          cp -r backend/node_modules deploy/backend/ || {
            echo "‚ö†Ô∏è Error copiando node_modules completo, intentando copiar solo xml2js..."
            mkdir -p deploy/backend/node_modules
            cp -r backend/node_modules/xml2js deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/@nestjs deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/@types deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/class-validator deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/class-transformer deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/reflect-metadata deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/rxjs deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/mongoose deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/bcrypt deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/passport deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/passport-jwt deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/nodemailer deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/cloudinary deploy/backend/node_modules/ 2>/dev/null || true
            cp -r backend/node_modules/multer deploy/backend/node_modules/ 2>/dev/null || true
            # Copiar archivos package.json de node_modules para resolver dependencias
            find backend/node_modules -name "package.json" -type f | head -100 | while read pkg; do
              rel_path=$(echo $pkg | sed 's|backend/node_modules/||')
              mkdir -p "deploy/backend/node_modules/$(dirname $rel_path)"
              cp "$pkg" "deploy/backend/node_modules/$rel_path" 2>/dev/null || true
            done
          }
          echo "‚úÖ Backend node_modules copiado"
        else
          echo "‚ùå ERROR: backend/node_modules no encontrado!"
          echo "‚ö†Ô∏è Intentando instalar dependencias..."
          cd backend
          npm install
          cd ..
          if [ -d "backend/node_modules" ]; then
            cp -r backend/node_modules deploy/backend/
            echo "‚úÖ node_modules instalado y copiado"
          else
            echo "‚ùå ERROR: No se pudo instalar node_modules"
            exit 1
          fi
        fi
        
        # Verificar que xml2js est√° en el deploy
        if [ -d "deploy/backend/node_modules/xml2js" ]; then
          echo "‚úÖ xml2js verificado en deploy/backend/node_modules/"
        else
          echo "‚ùå ERROR: xml2js NO est√° en deploy/backend/node_modules/"
          exit 1
        fi
        
        # Copiar archivos de configuraci√≥n para Hostinger
        echo "‚öôÔ∏è Copiando scripts de inicio y configuraci√≥n..."
        if [ -f backend/start.sh ]; then
          cp backend/start.sh deploy/backend/
          chmod +x deploy/backend/start.sh
          echo "‚úÖ start.sh copiado y hecho ejecutable"
        else
          echo "‚ö†Ô∏è start.sh no encontrado"
        fi
        if [ -f backend/start.bat ]; then
          cp backend/start.bat deploy/backend/
          echo "‚úÖ start.bat copiado"
        fi
        if [ -f backend/.htaccess ]; then
          cp backend/.htaccess deploy/backend/
          echo "‚úÖ backend/.htaccess copiado"
        fi
        if [ -f backend/ecosystem.config.js ]; then
          cp backend/ecosystem.config.js deploy/backend/
          echo "‚úÖ ecosystem.config.js copiado"
        fi
        
        # Verificar estructura final
        echo "üîç Verificando estructura del backend..."
        echo "  - dist/main.js: $([ -f deploy/backend/dist/main.js ] && echo '‚úÖ' || echo '‚ùå')"
        echo "  - package.json: $([ -f deploy/backend/package.json ] && echo '‚úÖ' || echo '‚ùå')"
        echo "  - node_modules/xml2js: $([ -d deploy/backend/node_modules/xml2js ] && echo '‚úÖ' || echo '‚ùå')"
        echo "  - start.sh: $([ -f deploy/backend/start.sh ] && echo '‚úÖ' || echo '‚ùå')"
        
        echo "‚úÖ Backend completamente preparado para deploy"
    
    - name: Deploy to Hostinger
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy/
        server-dir: /public_html/

